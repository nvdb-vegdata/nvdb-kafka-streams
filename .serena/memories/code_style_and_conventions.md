# Code Style and Conventions

## Language & Compilation
- **Language**: Kotlin 2.2.20 with Java 21 JVM toolchain
- **Compiler Options**:
  - `-Xjsr305=strict` - Strict JSR-305 nullability annotations
  - `-Xannotation-default-target=param-property` - Annotations target constructor properties by default
  - Opt-in experimental APIs: `kotlin.time.ExperimentalTime`, `kotlinx.coroutines.ExperimentalCoroutinesApi`, `kotlinx.serialization.ExperimentalSerializationApi`

## Package Structure
- Base package: `no.vegvesen.nvdb.kafka`
- Generated API models: `no.vegvesen.nvdb.api.uberiket.model`
- Clear separation by layer: api, config, controller, model, stream, service, repository, health

## Kotlin Conventions
- **Class Design**: Use data classes for models, sealed classes for ADTs
- **Null Safety**: Leverage Kotlin's null-safety features; avoid `!!` operator
- **Immutability**: Prefer `val` over `var`, immutable data structures
- **Extension Functions**: Use extensions to add functionality without inheritance (see `IterableExtensions.kt`)
- **Top-level Functions**: Main function and utilities defined at package level

## Spring Boot Patterns
- **Configuration**: Use `@ConfigurationProperties` with `@ConfigurationPropertiesScan` for type-safe configuration
- **Annotations**: 
  - `@SpringBootApplication` on main application class
  - `@EnableScheduling` for scheduled tasks
  - Component scanning and dependency injection via constructor injection
- **Property Binding**: Configuration classes in `config/` package bind to `application.yml`

## Serialization
- **Library**: kotlinx.serialization (NOT Jackson)
- **Custom Serializer**: `KotlinxJsonSerializer` for Kafka integration
- **Annotations**: Use `@Serializable` on data classes
- **Date/Time**: Use kotlinx-datetime types (`Instant`, `LocalDateTime`, etc.)

## Kafka Patterns
- **Serdes**: Custom `KotlinxJsonSerializer` for value serialization
- **Topology**: Define stream topologies in dedicated classes (`NvdbStreamTopology`)
- **Producer**: Scheduled/on-demand data production with progress tracking
- **Topics**: Configurable via `KafkaTopicProperties` with partition and replica settings

## Testing Conventions
- **Framework**: JUnit 5 with Spring Boot Test
- **Structure**: Arrange-Act-Assert pattern with comments for longer tests
- **Embedded Services**: Use embedded Kafka for integration tests
- **Mocking**: MockK for mocking Kotlin classes
- **No Wildcards**: Don't run tests with wildcards (*)
- **Private Methods**: Make methods public if they need unit testing rather than using reflection
- **Test Quality**: Write proper tests that assert correct outcomes, not just that failures occur

## Error Handling
- Clear error on last success, stop on error (as per recent commits)
- Leverage Kotlin's Result type or nullable returns where appropriate

## Comments
- Avoid unnecessary comments; prefer self-documenting code
- Only add comments that explain non-obvious logic
- No "Generated by Claude" or similar attribution comments

## Git Commits
- Never include "Generated with Claude Code" or "Co-Authored-By: Claude" in commit messages
- Use conventional commit messages
- Follow the project's existing commit style (see git log)

## LSP & IDE Integration
- Kotlin LSP is configured via `opencode.json`: `kotlin-lsp --stdio`
- Always use LSP to check for compilation errors when available
- Don't rely solely on Gradle compilation for error checking
